<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥åœ°ç†æ—©è¯»ä»»åŠ¡</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/quill/1.3.6/quill.snow.min.css" rel="stylesheet">
    <style>
        /* --- æ ·å¼ä¿æŒä¸å˜ --- */
        :root { var(--primary-color: #2c3e50; var(--accent-color: #3498db; var(--bg-color: #f0f2f5; var(--btn-hover: #2980b9; }
        body { font-family: sans-serif; background-color: #f0f2f5; margin: 0; padding: 10px; color: #333; }
        .container { max-width: 800px; margin: 20px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); position: relative; }
        .header { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        #current-date { font-size: 1.2em; color: #666; }
        #current-time { font-size: 2.8em; font-weight: bold; color: #2c3e50; letter-spacing: 2px; font-variant-numeric: tabular-nums; }
        .page { display: none; animation: fadeIn 0.5s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .content-box { min-height: 300px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background: #fff; margin-bottom: 20px; }
        .nav-btn { display: block; width: 100%; padding: 15px; background-color: #3498db; color: white; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; margin-top: 20px; }
        .nav-btn:hover { background-color: #2980b9; }
        .nav-btn.secondary { background-color: #95a5a6; }
        .lock-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 300px; background-color: #fff8e1; color: #d35400; border-radius: 8px; border: 2px dashed #f39c12; }
        #admin-panel { display: none; margin-top: 50px; border-top: 4px solid #3498db; padding-top: 20px; background: #fafafa; }
        .editor-container { background: white; height: 250px; margin-bottom: 20px; }
        .admin-bar { background: #e1e8ed; padding: 15px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .login-trigger { position: fixed; bottom: 10px; right: 10px; width: 40px; height: 40px; background: rgba(0,0,0,0.1); border-radius: 50%; cursor: pointer; z-index: 999; }
        /* åŠ è½½åŠ¨ç”» */
        #loading-mask { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display:flex; justify-content:center; align-items:center; font-size:1.5em; color:#3498db; }
    </style>
</head>
<body>

<div id="loading-mask">æ­£åœ¨è¿æ¥äº‘ç«¯æ•°æ®...</div>

<div class="container">
    <div class="header">
        <div id="current-date">æ­£åœ¨è·å–æ—¥æœŸ...</div>
        <div id="current-time">00:00:00</div>
    </div>

    <!-- æ—©è¯»é¡µ -->
    <div id="page-reading" class="page active">
        <h2 style="color: #2c3e50;">ğŸ“– ä»Šæ—¥æ—©è¯»ä»»åŠ¡</h2>
        <div id="display-reading" class="content-box ql-editor"></div>
        <button class="nav-btn" onclick="goToPage('dictation')">å®Œæˆæ—©è¯»ï¼Œè¿›å…¥é»˜å†™æ£€æµ‹ â†’</button>
    </div>

    <!-- é»˜å†™é¡µ -->
    <div id="page-dictation" class="page">
        <h2 style="color: #c0392b;">âœï¸ é»˜å†™æ£€æµ‹</h2>
        <div id="dictation-lock" class="lock-screen">
            <div style="font-size: 3em;">ğŸ”’</div>
            <p>é»˜å†™å°†åœ¨ <span id="lock-time-text" style="font-weight:bold; font-size:1.2em">--:--</span> å¼€å¯</p>
        </div>
        <div id="dictation-content-wrapper" style="display:none;">
            <div id="display-dictation" class="content-box ql-editor"></div>
        </div>
        <button class="nav-btn secondary" onclick="goToPage('reading')">â† è¿”å›æ—©è¯»ä»»åŠ¡</button>
    </div>

    <!-- è€å¸ˆåå° -->
    <div id="admin-panel">
        <h2 style="border-bottom:1px solid #ddd;">ğŸ”§ è€å¸ˆå‘å¸ƒåå°</h2>
        <h4>1. æ—©è¯»å†…å®¹ï¼š</h4> <div id="editor-reading" class="editor-container"></div>
        <h4>2. é»˜å†™å†…å®¹ï¼š</h4> <div id="editor-dictation" class="editor-container"></div>
        <div class="admin-bar">
            <div><label>â° é»˜å†™æ—¶é—´ï¼š</label><input type="time" id="time-setter" style="padding:5px;"></div>
            <button class="nav-btn" style="width: auto; margin:0; background: green;" onclick="saveDataToCloud()">â˜ï¸ å‘å¸ƒåˆ°äº‘ç«¯</button>
        </div>
    </div>
</div>

<div class="login-trigger" onclick="teacherLogin()"></div>

<!-- å¼•å…¥åº“æ–‡ä»¶ -->
<script src="https://cdn.bootcdn.net/ajax/libs/quill/1.3.6/quill.min.js"></script>
<script src="//code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>

<script>
    // ==========================================
    // âš ï¸âš ï¸ è¯·åœ¨è¿™é‡Œå¡«å†™ä½ çš„ LeanCloud å¯†é’¥ âš ï¸âš ï¸
    // ==========================================
    const APP_ID = 'w4PssPZqhegZCxoLoGXTN5DV-MdYXbMMI'; 
    const APP_KEY = 'tgdpr2Q2lVc8Fd9ETBEOVcwV';
    // ==========================================

    // 1. åˆå§‹åŒ–äº‘æ•°æ®åº“
    AV.init({ appId: APP_ID, appKey: APP_KEY, serverURL: "https://w4psspzq.api.lncldglobal.com" });

    // 2. åŸºç¡€é€»è¾‘
    function updateClock() {
        const now = new Date();
        document.getElementById('current-date').innerText = now.toLocaleDateString('zh-CN', {month:'long', day:'numeric', weekday:'long'});
        document.getElementById('current-time').innerText = now.toLocaleTimeString('zh-CN', {hour12:false});
        checkLockStatus();
    }
    setInterval(updateClock, 1000); updateClock();

    function goToPage(page) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.getElementById('page-' + page).classList.add('active');
    }

    // 3. ç¼–è¾‘å™¨åˆå§‹åŒ–
    let quillRead, quillWrite;
    const toolbarOptions = [[{ 'header': [1, 2, false] }], ['bold', 'italic', { 'color': [] }], [{ 'list': 'ordered'}, { 'list': 'bullet' }]];

    window.onload = function() {
        quillRead = new Quill('#editor-reading', { theme: 'snow', modules: { toolbar: toolbarOptions } });
        quillWrite = new Quill('#editor-dictation', { theme: 'snow', modules: { toolbar: toolbarOptions } });
        
        // é¡µé¢åŠ è½½å®Œæˆåï¼Œç«‹åˆ»ä»äº‘ç«¯æ‹‰å–æ•°æ®
        loadDataFromCloud();
    };

    // 4. ã€æ ¸å¿ƒã€‘ä»äº‘ç«¯è¯»å–æ•°æ®
    function loadDataFromCloud() {
        const query = new AV.Query('GeoClass');
        query.descending('createdAt'); // è·å–æœ€æ–°åˆ›å»ºçš„ä¸€æ¡
        query.first().then((todo) => {
            document.getElementById('loading-mask').style.display = 'none'; // éšè—åŠ è½½å±‚
            if (todo) {
                const data = todo.attributes;
                // æ›´æ–°å­¦ç”Ÿè§†å›¾
                document.getElementById('display-reading').innerHTML = data.reading || "æš‚æ— ä»»åŠ¡";
                document.getElementById('display-dictation').innerHTML = data.dictation || "";
                document.getElementById('lock-time-text').innerText = data.unlockTime || "æœªå®š";
                document.getElementById('time-setter').value = data.unlockTime || "";
                
                // æ›´æ–°è€å¸ˆç¼–è¾‘å™¨
                quillRead.root.innerHTML = data.reading || "";
                quillWrite.root.innerHTML = data.dictation || "";
                
                checkLockStatus();
            }
        }, (error) => {
            alert("è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å¯†é’¥ï¼š" + error.message);
        });
    }

    // 5. ã€æ ¸å¿ƒã€‘ä¿å­˜æ•°æ®åˆ°äº‘ç«¯
    function saveDataToCloud() {
        const GeoClass = AV.Object.extend('GeoClass');
        const task = new GeoClass();
        
        task.set('reading', quillRead.root.innerHTML);
        task.set('dictation', quillWrite.root.innerHTML);
        task.set('unlockTime', document.getElementById('time-setter').value);

        const btn = document.querySelector('.admin-bar button');
        btn.innerText = "æ­£åœ¨å‘å¸ƒ...";
        btn.disabled = true;

        task.save().then((todo) => {
            alert('âœ… å‘å¸ƒæˆåŠŸï¼å­¦ç”Ÿåˆ·æ–°é¡µé¢å³å¯çœ‹åˆ°ã€‚');
            btn.innerText = "â˜ï¸ å‘å¸ƒåˆ°äº‘ç«¯";
            btn.disabled = false;
            loadDataFromCloud(); // é‡æ–°æ‹‰å–ç¡®è®¤
        }, (error) => {
            alert('å‘å¸ƒå¤±è´¥ï¼š' + error.message);
            btn.innerText = "â˜ï¸ å‘å¸ƒåˆ°äº‘ç«¯";
            btn.disabled = false;
        });
    }

    // 6. é”å®šé€»è¾‘
    function checkLockStatus() {
        const unlockTime = document.getElementById('lock-time-text').innerText;
        if (unlockTime === "æœªå®š" || unlockTime === "--:--") return;
        
        const now = new Date();
        const cur = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
        
        if (cur >= unlockTime) {
            document.getElementById('dictation-lock').style.display = 'none';
            document.getElementById('dictation-content-wrapper').style.display = 'block';
        } else {
            document.getElementById('dictation-lock').style.display = 'flex';
            document.getElementById('dictation-content-wrapper').style.display = 'none';
        }
    }

    // 7. ç™»å½•
    function teacherLogin() {
        if(prompt("å¯†ç ") === "8888") {
            document.getElementById('admin-panel').style.display = 'block';
            setTimeout(()=>document.getElementById('admin-panel').scrollIntoView({behavior:"smooth"}),100);
        }
    }
</script>
</body>

</html>



